import argparse
import subprocess
import os
import atexit


def KillSNMPREC():
    print 'Killing snmpsimd.py ...'
    os.system('killall snmpsimd.py')
    os.system('killall snmpsimd.py')
    os.system('killall snmpsimd.py')


atexit.register(KillSNMPREC)


def MibCreate(bw):
    packets = str(bw * 131072 / 512)
    rate = str(bw * 131072)

    mib_content = "1.3.6.1.2.1.2.2.1.1.1|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.1.2|2|2\n" \
                  "1.3.6.1.2.1.2.2.1.1.3|2|3\n" \
                  "1.3.6.1.2.1.2.2.1.1.4|2|4\n" \
                  "1.3.6.1.2.1.2.2.1.1.5|2|5\n" \
                  "1.3.6.1.2.1.2.2.1.1.6|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.1.7|2|7\n" \
                  "1.3.6.1.2.1.2.2.1.1.8|2|8\n" \
                  "1.3.6.1.2.1.2.2.1.2.1|4|GigabitEthernet-1\n" \
                  "1.3.6.1.2.1.2.2.1.2.2|4|GigabitEthernet-2\n" \
                  "1.3.6.1.2.1.2.2.1.2.3|4|GigabitEthernet-3\n" \
                  "1.3.6.1.2.1.2.2.1.2.4|4|GigabitEthernet-4\n" \
                  "1.3.6.1.2.1.2.2.1.2.5|4|GigabitEthernet-5\n" \
                  "1.3.6.1.2.1.2.2.1.2.6|4|GigabitEthernet-6\n" \
                  "1.3.6.1.2.1.2.2.1.2.7|4|GigabitEthernet-7\n" \
                  "1.3.6.1.2.1.2.2.1.2.8|4|GigabitEthernet-8\n" \
                  "1.3.6.1.2.1.2.2.1.3.1|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.2|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.3|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.4|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.5|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.6|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.7|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.3.8|2|6\n" \
                  "1.3.6.1.2.1.2.2.1.7.1|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.2|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.3|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.4|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.5|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.6|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.7|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.7.8|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.8.1|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.8.2|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.8.3|2|2\n" \
                  "1.3.6.1.2.1.2.2.1.8.4|2|2\n" \
                  "1.3.6.1.2.1.2.2.1.8.5|2|1\n" \
                  "1.3.6.1.2.1.2.2.1.8.6|2|2\n" \
                  "1.3.6.1.2.1.2.2.1.8.7|2|2\n" \
                  "1.3.6.1.2.1.2.2.1.8.8|2|2\n" \
                  "1.3.6.1.2.1.2.2.1.10.1|65:numeric|offset=0,comulative=1,wrap=1,rate=%s\n" \
                  "1.3.6.1.2.1.2.2.1.10.2|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.10.3|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.10.4|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.10.5|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.10.6|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.10.7|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.10.8|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.1|65:numeric|offset=0,comulative=1,wrap=1,rate=%s\n" \
                  "1.3.6.1.2.1.2.2.1.11.2|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.3|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.4|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.5|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.6|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.7|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.11.8|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.1|65:numeric|offset=0,comulative=1,rate=%s,wrap=1\n" \
                  "1.3.6.1.2.1.2.2.1.16.2|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.3|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.4|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.5|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.6|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.7|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.16.8|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.1|65:numeric|offset=0,comulative=1,rate=%s,wrap=1\n" \
                  "1.3.6.1.2.1.2.2.1.17.2|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.3|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.4|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.5|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.6|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.7|65|0\n" \
                  "1.3.6.1.2.1.2.2.1.17.8|65|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.1|70:numeric|offset=0,comulative=1,rate=%s,wrap=1\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.2|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.3|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.4|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.5|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.6|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.7|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.6.8|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.1|70:numeric|offset=0,comulative=1,rate=%s,wrap=1\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.2|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.3|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.4|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.5|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.6|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.7|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.7.8|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.1|70:numeric|offset=0,comulative=1,rate=%s,wrap=1\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.2|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.3|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.4|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.5|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.6|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.7|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.10.8|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.1|70:numeric|offset=0,comulative=1,rate=%s,wrap=1\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.2|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.3|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.4|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.5|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.6|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.7|70|0\n" \
                  "1.3.6.1.2.1.31.1.1.1.11.8|70|0" % \
                  (rate, packets, rate, packets, rate, packets, rate, packets)

    with open('public.snmprec', 'w') as mib_file:
        mib_file.write(mib_content)


def StartSimulation(timeout, ip):
    os.system('\cp public.snmprec /usr/snmpsim/data/public.snmprec')
    os.system('killall snmpsimd.py')
    p = subprocess.Popen(
        ['timeout', '%s' % str(timeout * 60), '/usr/bin/snmpsimd.py', '--agent-udpv4-endpoint=%s:161' % ip,
         '--process-user=root', '--process-group=root'], stdout=subprocess.PIPE)
    while True:
        output = p.stdout.readline()
        if output == '' and p.poll() is not None:
            break
        if output:
            print output
    rc = p.poll()
    return rc


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--rate', help="Rate (in Mbps)", type=int, required=True)
    parser.add_argument('--duration', help="Simulation duration (in minutes)", type=int, required=True)
    parser.add_argument('--snmp', help="SNMP simulator IP address", required=True)
    args = parser.parse_args()

    print '\nSimulating SNMP traffic for %d minutes (rate~%d Mbps) ...\n' % (args.duration, args.rate)

    MibCreate(args.rate)
    StartSimulation(args.duration, args.snmp)
